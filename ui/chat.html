<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>CrewAI Chat (nobu)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Segoe UI,Meiryo,Arial;margin:1rem}
    #messages{height:60vh;overflow:auto;border:1px solid #ddd;padding:0.5rem;background:#fff}
    .msg{margin:0.25rem 0}
    .user{color:#0b66c3}
    .agent{color:#0b8c3a}
    #controls{margin-top:.5rem}
    input,button,select{font-size:1rem;padding:.4rem}
  </style>
</head>
<body>
  <h1>CrewAI Chat UI</h1>
  <p>簡易クライアント: Socket.IO 経由で `nobu` に話しかけます。</p>

  <div>
  <label>Server URL: <input id="server" value="http://127.0.0.1:5000" style="width:320px"></label>
  <label style="margin-left:1rem"><input type="checkbox" id="useOrigin"> Use same origin</label>
    <label style="margin-left:1rem">Agent: <input id="agent" value="nobu"></label>
    <button id="connect">Connect</button>
    <span id="status" style="margin-left:1rem;color:#666">disconnected</span>
  </div>

  <div id="messages" aria-live="polite"></div>

  <div id="controls">
    <input id="text" placeholder="メッセージを入力" style="width:60%" />
    <button id="send">Send</button>
  </div>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    let socket = null;
    let session = null;

  const serverEl = document.getElementById('server');
    const agentEl = document.getElementById('agent');
    const connectEl = document.getElementById('connect');
  const useOriginEl = document.getElementById('useOrigin');
    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const textEl = document.getElementById('text');
    const sendEl = document.getElementById('send');

    function append(kind, text){
      const d = document.createElement('div'); d.className='msg '+kind; d.textContent = text; messagesEl.appendChild(d); messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function updateServerField(){
    if(useOriginEl && useOriginEl.checked){ serverEl.readOnly = true; serverEl.value = window.location.origin; }
    else if(useOriginEl){ serverEl.readOnly = false; if(!serverEl.value) serverEl.value = 'http://127.0.0.1:5000'; }
    }
    if(useOriginEl){ useOriginEl.addEventListener('change', updateServerField); }
    updateServerField();

    connectEl.addEventListener('click', ()=>{
      if(socket && socket.connected){ socket.disconnect(); return; }
      // choose origin or user-specified server URL
      const url = (useOriginEl && useOriginEl.checked) ? window.location.origin : (serverEl.value.trim() || window.location.origin);
      append('agent','Connecting to '+url+' ...');
      // explicitly set the Socket.IO path to match server (Flask-SocketIO uses /socket.io by default)
      socket = io(url, {path: '/socket.io', transports:['websocket','polling'], reconnectionAttempts: 5});

      socket.on('connect', ()=>{ statusEl.textContent='connected'; connectEl.textContent='Disconnect'; append('agent','connected');
        socket.emit('start_session', { agent: agentEl.value || 'nobu' });
      });

      socket.on('session_started', (data)=>{ session = data.session; append('agent','session started: '+session+' (agent='+data.agent+')'); });

      socket.on('reply', (data)=>{ append('agent', `[${data.agent}] ${data.text}`); });
      socket.on('connected', (d)=>{ append('agent','server acknowledged: '+JSON.stringify(d)); });
      socket.on('disconnect', ()=>{ statusEl.textContent='disconnected'; connectEl.textContent='Connect'; append('agent','disconnected'); });
  socket.on('error', (e)=>{ append('agent','error: '+JSON.stringify(e)); console.error('socket error', e); });
    });

    sendEl.addEventListener('click', ()=>{ sendMessage(); });
    textEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ sendMessage(); } });

    function sendMessage(){
      const txt = textEl.value.trim();
      if(!txt) return;
      const agent = agentEl.value || 'nobu';
      if(socket && socket.connected && session){
        append('user','You: '+txt);
        socket.emit('message', { session: session, agent: agent, text: txt });
        textEl.value = '';
      } else {
        // fallback to HTTP POST
        fetch((serverEl.value || '') + '/chat', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ agent: agent, text: txt })
        }).then(r=>r.json()).then(j=>{ append('agent','[http] '+j.reply); session = j.session; }).catch(e=>append('agent','http error: '+e));
      }
    }
  </script>
</body>
</html>
