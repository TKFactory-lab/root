# RFP　— OpenAI Usage可視化 & Redmine自動更新

## 0. 背景と目的
- 私およびCrewAI（GPT-5系 3エージェント）はOpenAI APIを利用しており、**モデル別の使用状況（特に GPT‑5 / mini / nano の比率）** をRedmineで共有・監視したい。
- 本RFPの最重要方針は **「開発コスト（実装・統合作業工数）の極小化」**。ランニング費用ではなく、**開発作業を最短・最小で完遂** することを主眼に置く。

## 1. 成果物（Definition of Done）
- Redmine上に **単一のWikiページ**（ページ名例：`OpenAI_Usage`）が存在し、以下の情報を**テキストのみ**で自動更新できている。
  - 当月累計のUSD/JPY概算
  - モデル別（gpt‑5 / gpt‑5‑mini / gpt‑5‑nano / その他）の **リクエスト数・トークン数・推定コスト** と **構成比**
  - 直近N日（例：7日 or 30日）の **日次サマリ表**（日付・総額USD・主要モデル内訳）
  - 「改善メモ」欄（自動生成の一行コメント：例 *「今週はmini/nano比率↑」*）
- 自動更新は **外部スクリプト（プラグイン無し）** により行われ、**Redmine REST API** でWiki本文を上書きする。
- スクリプトは **環境変数のみで設定**（APIキー、Redmine URL、プロジェクトID、Wikiページ名）。
- セットアップ手順（README）と、**Redmineチケットでの導入証跡**（要件→実装→テスト→完了）が残っている。

## 2. スコープ（最小実装/MVP）
- **Redmineプラグイン開発はしない。**（開発コスト増のため）
- 画像やグラフは生成しない（**テキスト表のみ**）。
- データ保存は行わない（**都度API取得→整形→Wiki上書き**）。必要最小限のみキャッシュ可（前回実行時刻など）。
- 為替は **1回/更新時にUSD→JPY換算**（外部為替API or 設定固定レート）。
- Usage APIの呼び出しは **最小限（例：当月分、直近N日分のみ）**。

## 3. アウトオブスコープ（現時点でやらない）
- Redmineプラグイン・DBテーブル追加・マイグレーション
- 画像グラフ、添付ファイル運用、ダッシュボードUI
- 複雑な集計（ユーザー別/プロジェクト別の細分化、タグ付け高度化）
- 長期履歴の内製DB蓄積や高度なアラート・通知連携

## 4. 機能要件（テキスト出力仕様）
Wikiに出力される本文（Redmine記法）例：

```
h2. OpenAI 利用状況（YYYY-MM-DD HH:mm 更新）

* 今月累計: $<usd_total> （≒ <jpy_total> 円）  
* 直近<NDAYS>日: $<usd_ndays>  
* 為替レート: 1 USD = <rate> JPY

h3. モデル別内訳（今月）
| モデル | リクエスト数 | 入力tokens | 出力tokens | 合計tokens | 推定コストUSD | 構成比 |
| gpt-5 | <n_req> | <in_tok> | <out_tok> | <sum_tok> | $<usd> | <share>% |
| gpt-5-mini | ... |
| gpt-5-nano | ... |
| その他 | ... |

h3. 日次サマリ（直近<NDAYS>日）
| 日付 | 総額USD | gpt-5 | gpt-5-mini | gpt-5-nano | 備考 |
| 2025-08-18 | $1.23 | $0.90 | $0.28 | $0.05 |  |
| 2025-08-19 | ... |

h3. 改善メモ（自動）
* <auto_comment>（例：mini/nano比率が40%→52%へ改善）
```

※ 料金の正確性はUsage APIのコスト項目 or 単価テーブル×トークン数で推定（後述）。

## 5. 実装方針（開発コスト最小の設計）
- **方式**：外部スクリプト1本（推奨：Python）。
- **依存**：標準ライブラリ＋`requests` のみ（追加は最小限）。
- **構成**：
  - `fetch_usage()`：Usage APIを叩き、必要フィールドのみ抽出
  - `aggregate_by_model()`：gpt-5 / mini / nano で集計（その他は「その他」へ）
  - `estimate_cost()`：
    - a) Usage APIに金額が含まれる場合 → それを利用
    - b) 含まれない場合 → **固定の単価表**（JSON）を同梱し、`(in_tok, out_tok)` から算出
  - `format_redmine_text()`：Redmine表へ整形（行生成のみ、装飾簡素）
  - `update_wiki()`：Redmine RESTで本文を上書き
- **設定**：環境変数
  - `OPENAI_API_KEY` / `REDMINE_API_KEY` / `REDMINE_URL` / `REDMINE_PROJECT` / `REDMINE_WIKI_PAGE`
  - `FX_SOURCE`（`fixed` or `api`）・`FX_RATE_FIXED`
  - `LOOKBACK_DAYS`（日次サマリの期間）
- **スケジューリング**：OS標準（Windows Task Scheduler / cron）。追加サービスは導入しない。

## 6. コスト最小化のためのガードレール
- **プラグイン禁止**：拡張はREST/API連携のみに限定。
- **ノー・グラフィックス**：画像生成やChartライブラリ不使用。
- **I/O最小**：APIコールは当月＋直近N日のみに限定し、ページング最小化。
- **コード量上限**：目安として ~500行以内（テスト含まず）。
- **ライブラリ最小**：新規依存は極力避ける（保守と導入の手間削減）。
- **ドキュメント簡素**：READMEはセットアップ手順と環境変数一覧、実行例のみ。
- **秘密情報**：APIキーは環境変数のみ。コード・Wikiへ直書き禁止。

## 7. 単価テーブル（推定用・例）
> *注：正確な金額は最新ドキュメントに依存。ここでは推定計算用に**固定表**を同梱。*
```json
{
  "gpt-5":      {"prompt_per_1k": 0.0100, "completion_per_1k": 0.0100},
  "gpt-5-mini": {"prompt_per_1k": 0.0020, "completion_per_1k": 0.0020},
  "gpt-5-nano": {"prompt_per_1k": 0.0005, "completion_per_1k": 0.0005},
  "default":    {"prompt_per_1k": 0.0040, "completion_per_1k": 0.0040}
}
```
- 実際のレスポンスにUSD金額が含まれる場合はそれを優先。
- 含まれない場合のみ、上記テーブルで概算。

## 8. 例外・失敗時の挙動
- API失敗時：前回更新時刻とエラー概要のみをWiki先頭に記載（本文は前回値を維持）。
- 為替取得失敗：固定レートにフォールバック（環境変数で指定）。
- モデル名が未知：`その他` に集約。

## 9. セキュリティ
- APIキーは環境変数保管。リポジトリへのコミット禁止。
- Redmine接続はHTTPS前提。証明書検証ON。
- ログには金額と件数のみ（機密プロンプトを記録しない）。

## 10. 受け入れ条件（検収項目）
- 指定Wikiページがワンコマンド（またはスケジュール実行）で更新される。
- 今月の合計、モデル別内訳、日次サマリが正しく表示される。
- 直近の実行ログ（成功/失敗）が確認できる（標準出力 or 単一ログファイル）。
- README手順どおりに私の環境で再現できる。
- Redmineチケットに、要件→実装→テスト→導入の証跡が残っている。

## 11. タスク分割（Redmineチケット雛形）
1. 仕様確定（本RFP反映）
2. スクリプト雛形作成（環境変数・README・Redmine更新のモック）
3. Usage API連携（当月・直近N日）
4. 集計と推定コスト計算（単価テーブル対応）
5. Wiki本文フォーマット出力（テキスト表）
6. 為替レート対応（固定/外部APIフォールバック）
7. エラーハンドリングとログ
8. 動作確認（私のRedmineで検収）
9. 運用設定（Task Scheduler/cron 設定例をREADMEに追記）

## 12. 将来拡張（任意・別途）
- 長期履歴のCSV出力
- モデル比率のしきい値アラート（チケット/メール）
- エージェント別集計（CrewAIタグ付け）
- 画像グラフの自動添付（必要時のみ）

---
**注記**：本RFPは「開発コスト最小化」を最優先し、**プラグイン無し・テキストのみ・単一スクリプト**での達成を前提とする。これによりセットアップと保守の負担を極小化する。

